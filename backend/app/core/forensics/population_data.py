"""
Allele Frequency Knowledge Base — VANTAGE-STR Phase 3.5.

Contains realistic allele frequency data for 24 CODIS/ESS STR loci
across three major population groups. Frequencies are derived from
published reference distributions (NIST 1036 / ENFSI / Butler 2005).

Usage:
    from app.core.forensics.population_data import get_frequency, get_all_frequencies

    freq = get_frequency("D3S1358", 15, population="European")
    # → 0.2557

Structure:
    ALLELE_FREQUENCIES[population][marker][allele] = probability (0.0–1.0)
"""

from typing import Dict, Optional

# Minimum frequency floor (SWGDAM recommendation for rare/unobserved alleles)
MIN_FREQUENCY: float = 5e-4

# ═══════════════════════════════════════════════════════════════════════════════
# EUROPEAN POPULATION FREQUENCIES
# Source: NIST U.S. Caucasian reference + Butler et al. (2003/2005)
# ═══════════════════════════════════════════════════════════════════════════════

_EUROPEAN: Dict[str, Dict[float, float]] = {
    "CSF1PO": {
        7: 0.0019, 8: 0.0058, 9: 0.0252, 10: 0.2922, 11: 0.2961,
        12: 0.3301, 13: 0.0408, 14: 0.0078,
    },
    "D1S1656": {
        11: 0.0245, 12: 0.1196, 13: 0.0612, 14: 0.0816, 14.3: 0.0041,
        15: 0.1469, 15.3: 0.0735, 16: 0.0898, 16.3: 0.0612,
        17: 0.0898, 17.3: 0.1265, 18: 0.0408, 18.3: 0.0571,
        19.3: 0.0163, 20.3: 0.0041,
    },
    "D2S441": {
        9: 0.0020, 10: 0.1939, 11: 0.3347, 11.3: 0.0633, 12: 0.0449,
        13: 0.0163, 14: 0.2633, 15: 0.0612, 16: 0.0163,
    },
    "D2S1338": {
        16: 0.0233, 17: 0.1845, 18: 0.0874, 19: 0.1359, 20: 0.1359,
        21: 0.0388, 22: 0.0437, 23: 0.1408, 24: 0.0874, 25: 0.1068,
        26: 0.0097, 27: 0.0058,
    },
    "D3S1358": {
        12: 0.0019, 13: 0.0019, 14: 0.1068, 15: 0.2816, 16: 0.2524,
        17: 0.2136, 18: 0.1262, 19: 0.0136, 20: 0.0019,
    },
    "D5S818": {
        7: 0.0136, 8: 0.0039, 9: 0.0350, 10: 0.0544, 11: 0.3592,
        12: 0.3515, 13: 0.1553, 14: 0.0233, 15: 0.0039,
    },
    "D7S820": {
        7: 0.0136, 8: 0.1553, 9: 0.0816, 10: 0.2816, 11: 0.2019,
        12: 0.1942, 13: 0.0602, 14: 0.0117,
    },
    "D8S1179": {
        8: 0.0097, 9: 0.0117, 10: 0.0680, 11: 0.0583, 12: 0.1165,
        13: 0.3204, 14: 0.2282, 15: 0.1359, 16: 0.0408, 17: 0.0078,
        18: 0.0019,
    },
    "D10S1248": {
        12: 0.0327, 13: 0.2449, 14: 0.2959, 15: 0.2143, 16: 0.1429,
        17: 0.0510, 18: 0.0163,
    },
    "D12S391": {
        17: 0.0735, 18: 0.1837, 18.3: 0.0041, 19: 0.1429, 20: 0.1020,
        21: 0.1429, 22: 0.1143, 23: 0.1224, 24: 0.0735, 25: 0.0327,
        26: 0.0041,
    },
    "D13S317": {
        8: 0.1068, 9: 0.0680, 10: 0.0388, 11: 0.3301, 12: 0.2961,
        13: 0.0757, 14: 0.0787, 15: 0.0058,
    },
    "D16S539": {
        8: 0.0136, 9: 0.1165, 10: 0.0544, 11: 0.3204, 12: 0.2864,
        13: 0.1845, 14: 0.0194, 15: 0.0039,
    },
    "D18S51": {
        10: 0.0078, 11: 0.0117, 12: 0.1214, 13: 0.1214, 14: 0.1893,
        15: 0.1359, 16: 0.1456, 17: 0.1068, 18: 0.0680, 19: 0.0437,
        20: 0.0233, 21: 0.0136, 22: 0.0078, 23: 0.0019, 24: 0.0019,
    },
    "D19S433": {
        11: 0.0078, 12: 0.0602, 12.2: 0.0019, 13: 0.2379, 13.2: 0.0175,
        14: 0.3398, 14.2: 0.0233, 15: 0.1602, 15.2: 0.0544,
        16: 0.0437, 16.2: 0.0291, 17: 0.0136, 17.2: 0.0058,
    },
    "D21S11": {
        24.2: 0.0039, 25: 0.0019, 27: 0.0252, 28: 0.1553, 28.2: 0.0039,
        29: 0.2136, 29.2: 0.0058, 30: 0.2427, 30.2: 0.0680,
        31: 0.0680, 31.2: 0.1068, 32: 0.0117, 32.2: 0.0757,
        33.2: 0.0136, 34.2: 0.0039,
    },
    "D22S1045": {
        11: 0.0571, 14: 0.0041, 15: 0.2082, 16: 0.3673, 17: 0.2245,
        18: 0.1020, 19: 0.0327,
    },
    "FGA": {
        17: 0.0019, 18: 0.0117, 19: 0.0757, 20: 0.1068, 21: 0.1748,
        22: 0.1845, 23: 0.1553, 24: 0.1359, 25: 0.0874, 26: 0.0388,
        27: 0.0175, 28: 0.0058, 29: 0.0019, 30: 0.0019,
    },
    "SE33": {
        14: 0.0041, 15: 0.0286, 16: 0.0490, 17: 0.0735, 18: 0.0653,
        19: 0.0612, 20: 0.0857, 21: 0.0571, 22: 0.0490, 23: 0.0408,
        24: 0.0367, 24.2: 0.0082, 25: 0.0327, 25.2: 0.0041,
        26: 0.0286, 26.2: 0.0286, 27: 0.0245, 27.2: 0.0449,
        28: 0.0204, 28.2: 0.0490, 29: 0.0163, 29.2: 0.0490,
        30.2: 0.0367, 31.2: 0.0204, 32.2: 0.0163, 33.2: 0.0082,
    },
    "TH01": {
        6: 0.2330, 7: 0.1748, 8: 0.1068, 9: 0.1845, 9.3: 0.2524,
        10: 0.0350, 11: 0.0058, 13.3: 0.0019,
    },
    "TPOX": {
        6: 0.0019, 7: 0.0039, 8: 0.5340, 9: 0.0932, 10: 0.0544,
        11: 0.2718, 12: 0.0388, 13: 0.0019,
    },
    "VWA": {
        13: 0.0019, 14: 0.0952, 15: 0.1190, 16: 0.2143, 17: 0.2857,
        18: 0.1905, 19: 0.0714, 20: 0.0190, 21: 0.0019,
    },
    "PENTA_D": {
        2.2: 0.0041, 5: 0.0082, 7: 0.0082, 8: 0.0163, 9: 0.1735,
        10: 0.1122, 11: 0.1429, 12: 0.1633, 13: 0.1837, 14: 0.0898,
        15: 0.0449, 16: 0.0204, 17: 0.0163, 18: 0.0082,
    },
    "PENTA_E": {
        5: 0.0204, 7: 0.0857, 8: 0.0041, 9: 0.0041, 10: 0.0490,
        11: 0.1224, 12: 0.1633, 13: 0.0898, 14: 0.0694, 15: 0.0694,
        16: 0.0490, 17: 0.0776, 18: 0.0653, 19: 0.0612, 20: 0.0408,
        21: 0.0163, 22: 0.0082, 23: 0.0041,
    },
    "AMEL": {
        0: 0.5000,  # X
        1: 0.5000,  # Y
    },
}


# ═══════════════════════════════════════════════════════════════════════════════
# AFRICAN POPULATION FREQUENCIES
# Source: NIST U.S. African-American reference + Butler et al.
# ═══════════════════════════════════════════════════════════════════════════════

_AFRICAN: Dict[str, Dict[float, float]] = {
    "CSF1PO": {
        7: 0.0199, 8: 0.0259, 9: 0.0279, 10: 0.2271, 11: 0.1793,
        12: 0.3586, 13: 0.1076, 14: 0.0418, 15: 0.0120,
    },
    "D1S1656": {
        11: 0.0367, 12: 0.0612, 13: 0.0735, 14: 0.0980, 14.3: 0.0082,
        15: 0.1633, 15.3: 0.0490, 16: 0.1306, 16.3: 0.0653,
        17: 0.1020, 17.3: 0.0857, 18: 0.0571, 18.3: 0.0408,
        19.3: 0.0204, 20.3: 0.0082,
    },
    "D2S441": {
        9: 0.0040, 10: 0.1494, 11: 0.4263, 11.3: 0.0279, 12: 0.0837,
        13: 0.0199, 14: 0.2231, 15: 0.0518, 16: 0.0120,
    },
    "D2S1338": {
        15: 0.0080, 16: 0.0319, 17: 0.1076, 18: 0.0558, 19: 0.1913,
        20: 0.1594, 21: 0.1116, 22: 0.0558, 23: 0.1036, 24: 0.0757,
        25: 0.0797, 26: 0.0120, 27: 0.0080,
    },
    "D3S1358": {
        12: 0.0040, 13: 0.0040, 14: 0.0637, 15: 0.2789, 16: 0.2590,
        17: 0.1992, 18: 0.1434, 19: 0.0398, 20: 0.0080,
    },
    "D5S818": {
        7: 0.0518, 8: 0.0120, 9: 0.0398, 10: 0.0398, 11: 0.2390,
        12: 0.3148, 13: 0.2789, 14: 0.0159, 15: 0.0080,
    },
    "D7S820": {
        7: 0.0120, 8: 0.1434, 9: 0.1116, 10: 0.2789, 11: 0.1753,
        12: 0.1514, 13: 0.0876, 14: 0.0319, 15: 0.0080,
    },
    "D8S1179": {
        8: 0.0279, 9: 0.0279, 10: 0.0478, 11: 0.0558, 12: 0.1594,
        13: 0.2430, 14: 0.2271, 15: 0.1275, 16: 0.0598, 17: 0.0199,
        18: 0.0040,
    },
    "D10S1248": {
        11: 0.0082, 12: 0.0490, 13: 0.1837, 14: 0.2653, 15: 0.2245,
        16: 0.1633, 17: 0.0735, 18: 0.0245, 19: 0.0082,
    },
    "D12S391": {
        16: 0.0082, 17: 0.0898, 18: 0.1633, 19: 0.1592, 20: 0.1429,
        21: 0.1224, 22: 0.0980, 23: 0.0898, 24: 0.0735, 25: 0.0327,
        26: 0.0122, 27: 0.0082,
    },
    "D13S317": {
        8: 0.0319, 9: 0.0757, 10: 0.0319, 11: 0.2311, 12: 0.3386,
        13: 0.1355, 14: 0.1235, 15: 0.0279, 16: 0.0040,
    },
    "D16S539": {
        8: 0.0199, 9: 0.1594, 10: 0.0876, 11: 0.2470, 12: 0.2470,
        13: 0.1912, 14: 0.0359, 15: 0.0120,
    },
    "D18S51": {
        10: 0.0040, 11: 0.0159, 12: 0.0757, 13: 0.0956, 14: 0.1753,
        15: 0.1116, 16: 0.1275, 17: 0.1275, 18: 0.0876, 19: 0.0598,
        20: 0.0438, 21: 0.0319, 22: 0.0239, 23: 0.0120, 24: 0.0080,
    },
    "D19S433": {
        11: 0.0120, 12: 0.0757, 12.2: 0.0080, 13: 0.1793, 13.2: 0.0438,
        14: 0.2829, 14.2: 0.0558, 15: 0.1474, 15.2: 0.0757,
        16: 0.0398, 16.2: 0.0319, 17: 0.0279, 17.2: 0.0120,
    },
    "D21S11": {
        24.2: 0.0080, 27: 0.0359, 28: 0.1116, 29: 0.1792, 29.2: 0.0120,
        30: 0.2510, 30.2: 0.0598, 31: 0.0757, 31.2: 0.1036,
        32: 0.0239, 32.2: 0.0876, 33.2: 0.0279, 34.2: 0.0159,
    },
    "D22S1045": {
        11: 0.0898, 14: 0.0082, 15: 0.1633, 16: 0.3469, 17: 0.2449,
        18: 0.1143, 19: 0.0327,
    },
    "FGA": {
        17: 0.0040, 18: 0.0159, 19: 0.0558, 20: 0.0558, 21: 0.1275,
        22: 0.1514, 23: 0.1474, 24: 0.1753, 25: 0.1116, 26: 0.0876,
        27: 0.0398, 28: 0.0159, 29: 0.0040, 30: 0.0040, 30.2: 0.0040,
    },
    "SE33": {
        13: 0.0041, 14: 0.0122, 15: 0.0490, 16: 0.0571, 17: 0.0653,
        18: 0.0490, 19: 0.0612, 20: 0.0694, 21: 0.0490, 22: 0.0571,
        23: 0.0571, 24: 0.0408, 24.2: 0.0122, 25: 0.0327, 25.2: 0.0082,
        26: 0.0286, 26.2: 0.0245, 27: 0.0327, 27.2: 0.0408,
        28: 0.0286, 28.2: 0.0408, 29: 0.0204, 29.2: 0.0245,
        30.2: 0.0204, 31.2: 0.0163, 32.2: 0.0122, 33.2: 0.0082,
    },
    "TH01": {
        5: 0.0040, 6: 0.1036, 7: 0.3267, 8: 0.1275, 9: 0.1275,
        9.3: 0.2470, 10: 0.0518, 11: 0.0080,
    },
    "TPOX": {
        6: 0.0040, 7: 0.0080, 8: 0.3705, 9: 0.1116, 10: 0.0757,
        11: 0.2988, 12: 0.1036, 13: 0.0199, 14: 0.0080,
    },
    "VWA": {
        13: 0.0040, 14: 0.0558, 15: 0.0717, 16: 0.2271, 17: 0.2311,
        18: 0.2351, 19: 0.1275, 20: 0.0359, 21: 0.0080, 22: 0.0040,
    },
    "PENTA_D": {
        5: 0.0122, 7: 0.0082, 8: 0.0531, 9: 0.1306, 10: 0.1020,
        11: 0.1306, 12: 0.1633, 13: 0.1429, 14: 0.0898, 15: 0.0653,
        16: 0.0408, 17: 0.0327, 18: 0.0163, 19: 0.0082,
    },
    "PENTA_E": {
        5: 0.0571, 7: 0.0653, 8: 0.0082, 9: 0.0082, 10: 0.0367,
        11: 0.0776, 12: 0.1429, 13: 0.1020, 14: 0.0898, 15: 0.0735,
        16: 0.0612, 17: 0.0694, 18: 0.0653, 19: 0.0408, 20: 0.0408,
        21: 0.0327, 22: 0.0122, 23: 0.0082, 24: 0.0041,
    },
    "AMEL": {0: 0.5, 1: 0.5},
}


# ═══════════════════════════════════════════════════════════════════════════════
# EAST ASIAN POPULATION FREQUENCIES
# Source: NIST Asian reference + Tsuji et al. / Japanese/Chinese panels
# ═══════════════════════════════════════════════════════════════════════════════

_EAST_ASIAN: Dict[str, Dict[float, float]] = {
    "CSF1PO": {
        7: 0.0040, 8: 0.0080, 9: 0.0279, 10: 0.2351, 11: 0.2869,
        12: 0.3546, 13: 0.0558, 14: 0.0239, 15: 0.0040,
    },
    "D1S1656": {
        11: 0.0163, 12: 0.1429, 13: 0.0694, 14: 0.0898, 14.3: 0.0041,
        15: 0.1633, 15.3: 0.0612, 16: 0.0898, 16.3: 0.0653,
        17: 0.0857, 17.3: 0.0898, 18: 0.0490, 18.3: 0.0408,
        19.3: 0.0204, 20.3: 0.0082,
    },
    "D2S441": {
        9: 0.0040, 10: 0.2351, 11: 0.3108, 11.3: 0.0558, 12: 0.0478,
        13: 0.0199, 14: 0.2510, 15: 0.0558, 16: 0.0199,
    },
    "D2S1338": {
        16: 0.0279, 17: 0.1275, 18: 0.0558, 19: 0.1673, 20: 0.1514,
        21: 0.0757, 22: 0.0558, 23: 0.1275, 24: 0.0956, 25: 0.0876,
        26: 0.0199, 27: 0.0080,
    },
    "D3S1358": {
        13: 0.0040, 14: 0.0558, 15: 0.3187, 16: 0.2351, 17: 0.2032,
        18: 0.1594, 19: 0.0199, 20: 0.0040,
    },
    "D5S818": {
        7: 0.0199, 8: 0.0080, 9: 0.0518, 10: 0.0717, 11: 0.3028,
        12: 0.3227, 13: 0.1912, 14: 0.0279, 15: 0.0040,
    },
    "D7S820": {
        7: 0.0199, 8: 0.1434, 9: 0.0757, 10: 0.2470, 11: 0.2470,
        12: 0.1753, 13: 0.0717, 14: 0.0159, 15: 0.0040,
    },
    "D8S1179": {
        8: 0.0199, 9: 0.0239, 10: 0.0558, 11: 0.0478, 12: 0.1514,
        13: 0.3028, 14: 0.2112, 15: 0.1275, 16: 0.0438, 17: 0.0120,
        18: 0.0040,
    },
    "D10S1248": {
        12: 0.0408, 13: 0.2653, 14: 0.2857, 15: 0.2041, 16: 0.1388,
        17: 0.0490, 18: 0.0163,
    },
    "D12S391": {
        17: 0.0612, 18: 0.1633, 19: 0.1531, 20: 0.1327, 21: 0.1327,
        22: 0.1122, 23: 0.1020, 24: 0.0816, 25: 0.0408, 26: 0.0122,
        27: 0.0082,
    },
    "D13S317": {
        8: 0.0876, 9: 0.1036, 10: 0.0279, 11: 0.2789, 12: 0.3227,
        13: 0.0956, 14: 0.0717, 15: 0.0080, 16: 0.0040,
    },
    "D16S539": {
        8: 0.0120, 9: 0.1514, 10: 0.0717, 11: 0.2869, 12: 0.2590,
        13: 0.1873, 14: 0.0239, 15: 0.0080,
    },
    "D18S51": {
        10: 0.0040, 11: 0.0120, 12: 0.0876, 13: 0.1036, 14: 0.1753,
        15: 0.1434, 16: 0.1514, 17: 0.1116, 18: 0.0717, 19: 0.0558,
        20: 0.0359, 21: 0.0239, 22: 0.0120, 23: 0.0080, 24: 0.0040,
    },
    "D19S433": {
        11: 0.0080, 12: 0.0876, 13: 0.2151, 13.2: 0.0239, 14: 0.3108,
        14.2: 0.0359, 15: 0.1434, 15.2: 0.0558, 16: 0.0518,
        16.2: 0.0319, 17: 0.0199, 17.2: 0.0120, 18: 0.0040,
    },
    "D21S11": {
        24.2: 0.0040, 27: 0.0199, 28: 0.1275, 29: 0.2311, 29.2: 0.0080,
        30: 0.2629, 30.2: 0.0558, 31: 0.0757, 31.2: 0.0956,
        32: 0.0159, 32.2: 0.0717, 33.2: 0.0199, 34.2: 0.0080,
    },
    "D22S1045": {
        11: 0.0653, 14: 0.0041, 15: 0.1837, 16: 0.3571, 17: 0.2449,
        18: 0.1082, 19: 0.0327,
    },
    "FGA": {
        17: 0.0040, 18: 0.0159, 19: 0.0637, 20: 0.0876, 21: 0.1594,
        22: 0.1793, 23: 0.1594, 24: 0.1434, 25: 0.0956, 26: 0.0518,
        27: 0.0239, 28: 0.0080, 29: 0.0040, 30: 0.0040,
    },
    "SE33": {
        14: 0.0082, 15: 0.0367, 16: 0.0571, 17: 0.0694, 18: 0.0612,
        19: 0.0571, 20: 0.0776, 21: 0.0571, 22: 0.0531, 23: 0.0490,
        24: 0.0408, 24.2: 0.0082, 25: 0.0367, 25.2: 0.0041,
        26: 0.0327, 26.2: 0.0245, 27: 0.0286, 27.2: 0.0408,
        28: 0.0245, 28.2: 0.0408, 29: 0.0204, 29.2: 0.0245,
        30.2: 0.0204, 31.2: 0.0163, 32.2: 0.0122, 33.2: 0.0082,
    },
    "TH01": {
        6: 0.1753, 7: 0.2829, 8: 0.1036, 9: 0.1753, 9.3: 0.2072,
        10: 0.0438, 11: 0.0080,
    },
    "TPOX": {
        6: 0.0040, 7: 0.0040, 8: 0.4741, 9: 0.0996, 10: 0.0637,
        11: 0.3108, 12: 0.0359, 13: 0.0040, 14: 0.0040,
    },
    "VWA": {
        13: 0.0040, 14: 0.0797, 15: 0.0996, 16: 0.2351, 17: 0.2590,
        18: 0.2191, 19: 0.0757, 20: 0.0239, 21: 0.0040,
    },
    "PENTA_D": {
        5: 0.0082, 7: 0.0122, 8: 0.0327, 9: 0.1633, 10: 0.1224,
        11: 0.1429, 12: 0.1531, 13: 0.1633, 14: 0.0816, 15: 0.0531,
        16: 0.0327, 17: 0.0204, 18: 0.0082,
    },
    "PENTA_E": {
        5: 0.0327, 7: 0.0735, 8: 0.0041, 9: 0.0082, 10: 0.0449,
        11: 0.1020, 12: 0.1531, 13: 0.0980, 14: 0.0816, 15: 0.0694,
        16: 0.0571, 17: 0.0735, 18: 0.0653, 19: 0.0531, 20: 0.0408,
        21: 0.0204, 22: 0.0122, 23: 0.0041,
    },
    "AMEL": {0: 0.5, 1: 0.5},
}


# ═══════════════════════════════════════════════════════════════════════════════
# POPULATION REGISTRY
# ═══════════════════════════════════════════════════════════════════════════════

ALLELE_FREQUENCIES: Dict[str, Dict[str, Dict[float, float]]] = {
    "European": _EUROPEAN,
    "African": _AFRICAN,
    "East_Asian": _EAST_ASIAN,
}

AVAILABLE_POPULATIONS = list(ALLELE_FREQUENCIES.keys())

# All 24 loci (excluding AMEL for LR computation purposes)
CODIS_LOCI = [
    "CSF1PO", "D1S1656", "D2S441", "D2S1338", "D3S1358",
    "D5S818", "D7S820", "D8S1179", "D10S1248", "D12S391",
    "D13S317", "D16S539", "D18S51", "D19S433", "D21S11",
    "D22S1045", "FGA", "SE33", "TH01", "TPOX", "VWA",
    "PENTA_D", "PENTA_E",
]


# ═══════════════════════════════════════════════════════════════════════════════
# PUBLIC API
# ═══════════════════════════════════════════════════════════════════════════════

def get_frequency(
    marker: str,
    allele: float,
    population: str = "European",
) -> float:
    """
    Look up the frequency of a specific allele at a given locus.

    Args:
        marker: STR locus name (e.g., "D3S1358")
        allele: Allele repeat count (e.g., 15 or 9.3)
        population: Population group ("European", "African", "East_Asian")

    Returns:
        Frequency as float. Falls back to MIN_FREQUENCY if allele is
        unobserved in the reference database.
    """
    pop_data = ALLELE_FREQUENCIES.get(population, _EUROPEAN)
    marker_data = pop_data.get(marker, {})
    return marker_data.get(allele, MIN_FREQUENCY)


def get_all_frequencies(
    marker: str,
    population: str = "European",
) -> Dict[float, float]:
    """Return the full frequency distribution for a marker in a population."""
    pop_data = ALLELE_FREQUENCIES.get(population, _EUROPEAN)
    return pop_data.get(marker, {})


def get_average_frequency(marker: str, population: str = "European") -> float:
    """Return the average allele frequency for a marker (used for rarity scoring)."""
    freqs = get_all_frequencies(marker, population)
    if not freqs:
        return MIN_FREQUENCY
    return sum(freqs.values()) / len(freqs)
